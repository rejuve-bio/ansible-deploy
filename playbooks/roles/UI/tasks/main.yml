---
- name: Ensure UI directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id | default(ansible_user) }}"
    group: "{{ ansible_user_id | default(ansible_user) }}"

- name: Clone UI repository
  ansible.builtin.git:
    repo: "https://github.com/yisehak-awm/annotation-tool.git"
    dest: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui"
    version: writer
    force: yes
    update: yes

- name: Copy .env file for UI
  ansible.builtin.copy:
    src: "templates/UI.env"
    dest: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui/.env"
    mode: '0644'
    owner: "{{ ansible_user_id | default(ansible_user) }}"
    group: "{{ ansible_user_id | default(ansible_user) }}"
    force: yes

- name: Copy docker run script
  ansible.builtin.copy:
    src: "files/docker-ui-run.sh"
    dest: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui/docker-ui-run.sh"
    mode: '0755'
    owner: "{{ ansible_user_id | default(ansible_user) }}"
    group: "{{ ansible_user_id | default(ansible_user) }}"
    force: yes

- name: Ensure docker run script is executable
  ansible.builtin.command:
    cmd: "chmod +x /home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui/docker-ui-run.sh"

- name: Run UI Docker build and container via script
  ansible.builtin.command:
    cmd: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui/docker-ui-run.sh"
    chdir: "/home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui"

- name: Get network interfaces information
  ansible.builtin.shell:
    cmd: |
      ip -o -4 addr show scope global | awk '{print $4}' | cut -d'/' -f1
  register: network_ips
  changed_when: false

- name: Filter out common internal/docker IP ranges
  set_fact:
    valid_ips: "{{ network_ips.stdout_lines | reject('match', '^127\\.') | reject('match', '^172\\.1[7-9]\\.') | reject('match', '^172\\.2[0-9]\\.') | reject('match', '^172\\.3[0-1]\\.') | reject('match', '^10\\.') | reject('match', '^192\\.168\\.') | reject('match', '^169\\.254\\.') | list }}"

- name: Get default gateway IP for the Annotation_UI
  ansible.builtin.shell:
    cmd: |
      ip route get 1.1.1.1 | awk '{print $7}' | head -1
  register: gateway_ip
  changed_when: false

- name: Create prioritized list of working URLs
  set_fact:
    working_urls: "{{ ['http://localhost:3000'] }}"

- name: Add gateway IP to URLs for the Annotation_UI
  set_fact:
    working_urls: "{{ working_urls + ['http://' + gateway_ip.stdout + ':3000'] }}"
  when: gateway_ip.stdout and gateway_ip.stdout not in valid_ips

- name: Add other valid IPs to URLs
  set_fact:
    working_urls: "{{ working_urls + ['http://' + item + ':3000'] }}"
  loop: "{{ valid_ips }}"
  when: item != gateway_ip.stdout

- name: Check if Custom Atomspace Builder container is running
  shell: docker ps --filter "name=atomspace-api" --filter "status=running" -q
  register: custom_atomspace_status
  changed_when: false

- name: Check if Annotation container is running
  shell: docker ps --filter "name=annotation_annotation_service_1" --filter "status=running" -q
  register: annotation_status
  changed_when: false

- name: Display deployment confirmation 
  pause:
    prompt: |
      
      ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰ğŸŠğŸ‰
      
      {% if custom_atomspace_status.stdout and annotation_status.stdout %}
          âœ¨ CONGRATULATIONS! âœ¨
          Your Annotation UI is LIVE and ready to use! ğŸš€
          All dependent services are UP and running! âœ…
      {% else %}
          âš ï¸ ATTENTION! âš ï¸
          Some required services are not running:
          {% if not custom_atomspace_status.stdout %}- Custom Atomspace Builder ğŸš«{% endif %}
          {% if not annotation_status.stdout %}- Generic Annotation ğŸš«{% endif %}
          
          Please start them before using the UI!
      {% endif %}
      
      ğŸ“‚ Installed at: /home/{{ ansible_user_id | default(ansible_user) }}/annotation-ui
      
      ğŸ¯ YOUR ANNOTATION PORTAL:
      ================================================================
      {% for url in working_urls %}
      ğŸŒŸ Option {{ loop.index }}: {{ url }}
      {% endfor %}
      ================================================================
      
      ğŸ® HOW TO ACCESS:
      - ğŸ§ WSL users? -> Use IP addresses above (not localhost!)
      - ğŸ–¥ï¸ Linux/Mac? -> http://localhost:3000 OR IP addresses
      - ğŸŒ Remote access? -> Use IP addresses only
      - ğŸ›¡ï¸ Connection issues? -> Check port 3000 in firewall
      - ğŸ“± Mobile device? -> Any IP address works on mobile too!
      
      ğŸ” NEED TO DEBUG?
      - ğŸ“Š Live logs: tail -f ~/annotation-ui/ui.log
      - ğŸ³ Container: docker logs ui  
      - ğŸ”§ Status: docker ps | grep  ui:latest
      
      ğŸ¯ START ANNOTATING:
      ================================================================
      1. Open your favorite browser ğŸŒ                         
      2. Copy one of the URLs above ğŸ“‹                         
      3. Start your annotation project! âœ¨                     
      ================================================================
      
      ğŸ‰ Press ENTER when you are ready to begin! ğŸ‰
    seconds: 5
