- name: Check annotation service status
  docker_container_info:
    name: annotation_annotation_service_1
  register: annotation_service
  ignore_errors: yes

- name: Check atomspace-api status
  docker_container_info:
    name: atomspace-api
  register: atomspace_api
  ignore_errors: yes

# FAIL if services aren't running
- name: Validate services
  fail:
    msg: |
      ‚ùå ERROR: Required services not running:
      {% if annotation_service.container is not defined or annotation_service.container.State.Status != "running" %}
      - Annotation service (port 5800) is DOWN. Start it with:
          docker-compose up -d annotation_service
      {% endif %}
      {% if atomspace_api.container is not defined or atomspace_api.container.State.Status != "running" %}
      - AtomSpace-API (port 8001) is DOWN. Start it with:
          docker-compose up -d atomspace-api
      {% endif %}
      üîÑ After starting, re-run this playbook.
  when: 
    - (annotation_service.container is not defined) or 
      (annotation_service.container.State.Status != "running") or
      (atomspace_api.container is not defined) or 
      (atomspace_api.container.State.Status != "running")

# CONNECT to network if both are up
- name: Connect annotation service to rejuve-services-net if not already connected
  docker_network:
    name: rejuve-services-net
    connected: "{{ annotation_service.container.Id }}"
    state: present
  when: "'rejuve-services-net' not in annotation_service.container.NetworkSettings.Networks"
  register: connect_annotation_result

- name: Notify annotation service already connected
  debug:
    msg: "‚ÑπÔ∏è Annotation service is already connected to rejuve-services-net"
  when: "'rejuve-services-net' in annotation_service.container.NetworkSettings.Networks"

- name: Connect atomspace-api to rejuve-services-net if not already connected
  docker_network:
    name: rejuve-services-net
    connected: "{{ atomspace_api.container.Id }}"
    state: present
  when: "'rejuve-services-net' not in atomspace_api.container.NetworkSettings.Networks"
  register: connect_atomspace_result

- name: Notify atomspace-api already connected
  debug:
    msg: "‚ÑπÔ∏è AtomSpace-API is already connected to rejuve-services-net"
  when: "'rejuve-services-net' in atomspace_api.container.NetworkSettings.Networks"


- name: Confirm network success
  debug:
    msg:
      - "AtomSpace-API GET endpoint: http://localhost:8001/docs"
      - "‚úÖ SUCCESS: Services are now networked!"
      - "Annotation service POST endpoint: http://annotation_annotation_service_1:5800"
      - "üîÑ Use a POST request to http://annotation_annotation_service_1:5800"
     


